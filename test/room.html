<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Session</title>
</head>
<body>
<h1 id="title">Starting a room...</h1>

<div class="videoContainer">
    <video id="localVideo" style="height: 150px;" oncontextmenu="return false;"></video>
    <div id="localVolume" class="volume_bar"></div>
</div>
<div id="remotes"></div>

<button id="screenShareButton"></button>

<form id="stopRoom">
    <button type="submit">Stop Live Q&A!</button>
</form>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="../out/simplewebrtc-with-adapter.bundle.js"></script>
<style>
    .videoContainer {
        position: relative;
        width: 200px;
        height: 150px;
    }
    .videoContainer video {
        position: absolute;
        width: 100%;
        height: 100%;
    }
    .volume_bar {
        position: absolute;
        width: 5px;
        height: 0px;
        right: 0px;
        bottom: 0px;
        background-color: #12acef;
    }
</style>
<script>
    var url = new URL(location.href);
    var room = url.searchParams.get("name");
    if (room) {
        $('h1').text("Started Live Q&A for session " + room);
        $('body').addClass('active');

        // create our webrtc connection
        var webrtc = new SimpleWebRTC({
            // the id/element dom element that will hold "our" video
            localVideoEl: 'localVideo',
            // the id/element dom element that will hold remote videos
            remoteVideosEl: '',
            // immediately ask for camera access
            autoRequestMedia: true,
            debug: false,
            detectSpeakingEvents: true
        });

        // when it's ready, join if we got a room from the URL
        webrtc.on('readyToCall', function () {
            // you can name it anything
            webrtc.joinRoom(room);
        });

        function showVolume(el, volume) {
            if (!el) return;
            if (volume < -45) { // vary between -45 and -20
                el.style.height = '0px';
            } else if (volume > -20) {
                el.style.height = '100%';
            } else {
                el.style.height = '' + Math.floor((volume + 100) * 100 / 25 - 220) + '%';
            }
        }

        webrtc.on('channelMessage', function (peer, label, data) {
            if (data.type == 'volume') {
                showVolume(document.getElementById('volume_' + peer.id), data.volume);
            }
        });

        webrtc.on('videoAdded', function (video, peer) {
            console.log('video added', peer);
            var remotes = document.getElementById('remotes');
            if (remotes) {
                var d = document.createElement('div');
                d.className = 'videoContainer';
                d.id = 'container_' + webrtc.getDomId(peer);
                d.appendChild(video);
                var vol = document.createElement('div');
                vol.id = 'volume_' + peer.id;
                vol.className = 'volume_bar';
                video.onclick = function () {
                    video.style.width = video.videoWidth + 'px';
                    video.style.height = video.videoHeight + 'px';
                };
                d.appendChild(vol);
                remotes.appendChild(d);
            }
        });
        webrtc.on('videoRemoved', function (video, peer) {
            console.log('video removed ', peer);
            var remotes = document.getElementById('remotes');
            var el = document.getElementById('container_' + webrtc.getDomId(peer));
            if (remotes && el) {
                remotes.removeChild(el);
            }
        });
        webrtc.on('volumeChange', function (volume, treshold) {
            //console.log('own volume', volume);
            showVolume(document.getElementById('localVolume'), volume);
        });

        var button = $('#screenShareButton'),
            setButton = function (bool) {
                button.text(bool ? 'share screen' : 'stop sharing');
            };
        webrtc.on('localScreenStopped', function () {
            setButton(true);
        });

        setButton(true);

        button.click(function () {
            if (webrtc.getLocalScreen()) {
                webrtc.stopScreenShare();
                setButton(true);
            } else {
                webrtc.shareScreen(function (err) {
                    if (err) {
                        setButton(true);
                    } else {
                        setButton(false);
                    }
                });

            }
        });

        // stop room
        $('#stopRoom').submit(function () {
            window.location.href = '/test';
        });

        // create a room
        var val = room.toLowerCase().replace(/\s/g, '-').replace(/[^A-Za-z0-9_\-]/g, '');
        webrtc.createRoom(val, function (err, name) {
            console.log(' create room cb', arguments);
            if (err) {
                console.log(err);
                window.location.href = '/test';
            }
        });
    }
    else {
        window.location.href = '/test';
    }
</script>
</body>
</html>